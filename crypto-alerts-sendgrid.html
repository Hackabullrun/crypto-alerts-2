<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alertas de Precios Crypto</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 min-h-screen text-white">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                üö® Alertas de Precios Crypto
            </h1>
            <p class="text-gray-300">Recibe notificaciones por email cuando tus activos crucen los umbrales de precio</p>
        </div>

        <!-- Server Configuration -->
        <div class="bg-white/10 backdrop-blur-lg rounded-lg p-6 mb-6 border border-white/20">
            <h2 class="text-xl font-semibold mb-4">üîß Configuraci√≥n del Servidor</h2>
            <div class="flex gap-4 mb-4">
                <input 
                    type="text" 
                    id="serverUrl" 
                    placeholder="http://localhost:3000" 
                    value="http://localhost:3000"
                    class="flex-1 px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:border-purple-400 focus:outline-none"
                />
                <button 
                    onclick="testServer()" 
                    class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition">
                    Probar Conexi√≥n
                </button>
            </div>
            <p class="text-sm text-gray-400" id="serverStatus">üî¥ No conectado</p>
        </div>

        <!-- Email Configuration -->
        <div class="bg-white/10 backdrop-blur-lg rounded-lg p-6 mb-6 border border-white/20">
            <h2 class="text-xl font-semibold mb-4">üìß Configuraci√≥n de Email</h2>
            <div class="flex gap-4 mb-4">
                <input 
                    type="email" 
                    id="userEmail" 
                    placeholder="tu@email.com" 
                    class="flex-1 px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:border-purple-400 focus:outline-none"
                />
                <button 
                    onclick="saveEmail()" 
                    class="px-6 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold transition">
                    Guardar
                </button>
            </div>
            <button 
                onclick="sendTestEmail()" 
                class="w-full px-6 py-2 bg-green-600 hover:bg-green-700 rounded-lg font-semibold transition mb-2">
                üì® Enviar Email de Prueba
            </button>
            <p class="text-sm text-gray-400" id="emailStatus">Email no configurado</p>
        </div>

        <!-- Add New Alert -->
        <div class="bg-white/10 backdrop-blur-lg rounded-lg p-6 mb-6 border border-white/20">
            <h2 class="text-xl font-semibold mb-4">‚ûï Nueva Alerta</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                <select id="symbolSelect" class="px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:border-purple-400 focus:outline-none">
                    <option value="">Seleccionar activo...</option>
                    <option value="BTCUSDT">Bitcoin (BTC)</option>
                    <option value="ETHUSDT">Ethereum (ETH)</option>
                    <option value="BNBUSDT">BNB</option>
                    <option value="SOLUSDT">Solana (SOL)</option>
                    <option value="XRPUSDT">Ripple (XRP)</option>
                    <option value="ADAUSDT">Cardano (ADA)</option>
                    <option value="DOGEUSDT">Dogecoin (DOGE)</option>
                    <option value="DOTUSDT">Polkadot (DOT)</option>
                    <option value="MATICUSDT">Polygon (MATIC)</option>
                    <option value="AVAXUSDT">Avalanche (AVAX)</option>
                </select>
                
                <input 
                    type="number" 
                    id="lowerThreshold" 
                    placeholder="Umbral inferior ($)" 
                    step="0.01"
                    class="px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:border-purple-400 focus:outline-none"
                />
                
                <input 
                    type="number" 
                    id="upperThreshold" 
                    placeholder="Umbral superior ($)" 
                    step="0.01"
                    class="px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:border-purple-400 focus:outline-none"
                />
                
                <button 
                    onclick="addAlert()" 
                    class="px-6 py-2 bg-green-600 hover:bg-green-700 rounded-lg font-semibold transition col-span-1 md:col-span-2 lg:col-span-2">
                    Crear Alerta
                </button>
            </div>
        </div>

        <!-- Active Alerts -->
        <div class="bg-white/10 backdrop-blur-lg rounded-lg p-6 mb-6 border border-white/20">
            <h2 class="text-xl font-semibold mb-4">üìä Alertas Activas</h2>
            <div id="alertsList" class="space-y-3">
                <p class="text-gray-400 text-center py-8">No hay alertas configuradas</p>
            </div>
        </div>

        <!-- Alert History -->
        <div class="bg-white/10 backdrop-blur-lg rounded-lg p-6 border border-white/20">
            <h2 class="text-xl font-semibold mb-4">üìú Historial de Alertas Disparadas</h2>
            <div id="historyList" class="space-y-2">
                <p class="text-gray-400 text-center py-4">No hay alertas disparadas a√∫n</p>
            </div>
        </div>

        <!-- Status Indicator -->
        <div class="fixed bottom-4 right-4 px-4 py-2 rounded-full shadow-lg flex items-center gap-2" id="statusIndicator">
            <div class="w-2 h-2 bg-white rounded-full animate-pulse"></div>
            <span class="text-sm font-semibold">Monitoreando</span>
        </div>
    </div>

    <script>
        let alerts = [];
        let prices = {};
        let triggeredAlerts = [];
        let userEmail = '';
        let serverUrl = 'http://localhost:3000';
        let monitoringInterval = null;
        let serverConnected = false;

        // Load saved data
        function loadData() {
            const savedUrl = localStorage.getItem('serverUrl');
            if (savedUrl) {
                serverUrl = savedUrl;
                document.getElementById('serverUrl').value = savedUrl;
            }

            const savedEmail = localStorage.getItem('userEmail');
            if (savedEmail) {
                userEmail = savedEmail;
                document.getElementById('userEmail').value = savedEmail;
                document.getElementById('emailStatus').textContent = `‚úÖ Email configurado: ${savedEmail}`;
            }

            const savedAlerts = localStorage.getItem('alerts');
            if (savedAlerts) {
                alerts = JSON.parse(savedAlerts);
            }

            const savedHistory = localStorage.getItem('triggeredAlerts');
            if (savedHistory) {
                triggeredAlerts = JSON.parse(savedHistory);
                renderHistory();
            }
        }

        // Test server connection
        async function testServer() {
            const url = document.getElementById('serverUrl').value.trim();
            serverUrl = url;
            localStorage.setItem('serverUrl', url);

            try {
                const response = await fetch(`${url}/health`);
                const data = await response.json();
                
                if (data.status === 'ok') {
                    serverConnected = true;
                    document.getElementById('serverStatus').textContent = 'üü¢ Conectado y funcionando';
                    updateStatusIndicator(true);
                    showNotification('Servidor conectado correctamente', 'success');
                } else {
                    throw new Error('Respuesta inv√°lida');
                }
            } catch (error) {
                serverConnected = false;
                document.getElementById('serverStatus').textContent = 'üî¥ No se puede conectar al servidor';
                updateStatusIndicator(false);
                showNotification('Error: No se puede conectar al servidor. Aseg√∫rate de que est√© corriendo.', 'error');
            }
        }

        // Update status indicator
        function updateStatusIndicator(connected) {
            const indicator = document.getElementById('statusIndicator');
            if (connected) {
                indicator.className = 'fixed bottom-4 right-4 bg-green-600 px-4 py-2 rounded-full shadow-lg flex items-center gap-2';
            } else {
                indicator.className = 'fixed bottom-4 right-4 bg-red-600 px-4 py-2 rounded-full shadow-lg flex items-center gap-2';
            }
        }

        // Save email
        function saveEmail() {
            const email = document.getElementById('userEmail').value.trim();
            if (!email || !email.includes('@')) {
                showNotification('Por favor ingresa un email v√°lido', 'error');
                return;
            }
            userEmail = email;
            localStorage.setItem('userEmail', email);
            document.getElementById('emailStatus').textContent = `‚úÖ Email configurado: ${email}`;
            showNotification('Email guardado correctamente', 'success');
        }

        // Send test email
        async function sendTestEmail() {
            if (!userEmail) {
                showNotification('Por favor configura tu email primero', 'error');
                return;
            }

            if (!serverConnected) {
                showNotification('Por favor conecta al servidor primero', 'error');
                return;
            }

            try {
                const response = await fetch(`${serverUrl}/api/test-email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ to: userEmail })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('‚úÖ Email de prueba enviado. Revisa tu bandeja de entrada.', 'success');
                } else {
                    showNotification(`‚ùå Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showNotification('Error al enviar email de prueba', 'error');
                console.error('Error:', error);
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-4 rounded-lg shadow-lg text-white z-50 ${
                type === 'success' ? 'bg-green-600' : 
                type === 'error' ? 'bg-red-600' : 
                'bg-blue-600'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Add new alert
        function addAlert() {
            const symbol = document.getElementById('symbolSelect').value;
            const lower = parseFloat(document.getElementById('lowerThreshold').value);
            const upper = parseFloat(document.getElementById('upperThreshold').value);

            if (!symbol) {
                showNotification('Selecciona un activo', 'error');
                return;
            }

            if (isNaN(lower) && isNaN(upper)) {
                showNotification('Debes configurar al menos un umbral (inferior o superior)', 'error');
                return;
            }

            if (!isNaN(lower) && !isNaN(upper) && lower >= upper) {
                showNotification('El umbral inferior debe ser menor que el superior', 'error');
                return;
            }

            const alert = {
                id: Date.now(),
                symbol,
                lowerThreshold: isNaN(lower) ? null : lower,
                upperThreshold: isNaN(upper) ? null : upper,
                active: true,
                createdAt: new Date().toISOString()
            };

            alerts.push(alert);
            saveAlerts();
            renderAlerts();

            // Clear form
            document.getElementById('symbolSelect').value = '';
            document.getElementById('lowerThreshold').value = '';
            document.getElementById('upperThreshold').value = '';

            showNotification('Alerta creada correctamente', 'success');
        }

        // Remove alert
        function removeAlert(id) {
            alerts = alerts.filter(a => a.id !== id);
            saveAlerts();
            renderAlerts();
            showNotification('Alerta eliminada', 'info');
        }

        // Toggle alert
        function toggleAlert(id) {
            const alert = alerts.find(a => a.id === id);
            if (alert) {
                alert.active = !alert.active;
                saveAlerts();
                renderAlerts();
                showNotification(`Alerta ${alert.active ? 'activada' : 'pausada'}`, 'info');
            }
        }

        // Save alerts to localStorage
        function saveAlerts() {
            localStorage.setItem('alerts', JSON.stringify(alerts));
        }

        // Render alerts list
        function renderAlerts() {
            const container = document.getElementById('alertsList');
            
            if (alerts.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8">No hay alertas configuradas</p>';
                return;
            }

            container.innerHTML = alerts.map(alert => {
                const currentPrice = prices[alert.symbol] || 'Cargando...';
                const symbol = alert.symbol.replace('USDT', '');
                
                return `
                    <div class="bg-white/5 rounded-lg p-4 border border-white/10 ${!alert.active ? 'opacity-50' : ''}">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="text-lg font-bold">${symbol}</span>
                                    <span class="text-2xl font-bold text-purple-400">$${typeof currentPrice === 'number' ? currentPrice.toFixed(2) : currentPrice}</span>
                                </div>
                                <div class="flex gap-4 text-sm">
                                    ${alert.lowerThreshold !== null ? 
                                        `<span class="text-red-400">‚Üì Inferior: $${alert.lowerThreshold.toFixed(2)}</span>` : ''}
                                    ${alert.upperThreshold !== null ? 
                                        `<span class="text-green-400">‚Üë Superior: $${alert.upperThreshold.toFixed(2)}</span>` : ''}
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button 
                                    onclick="toggleAlert(${alert.id})" 
                                    class="px-4 py-2 rounded-lg ${alert.active ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-green-600 hover:bg-green-700'} transition">
                                    ${alert.active ? 'Pausar' : 'Activar'}
                                </button>
                                <button 
                                    onclick="removeAlert(${alert.id})" 
                                    class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition">
                                    Eliminar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render history
        function renderHistory() {
            const container = document.getElementById('historyList');
            
            if (triggeredAlerts.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">No hay alertas disparadas a√∫n</p>';
                return;
            }

            container.innerHTML = triggeredAlerts.slice().reverse().slice(0, 20).map(trigger => {
                const date = new Date(trigger.timestamp);
                const symbol = trigger.symbol.replace('USDT', '');
                return `
                    <div class="bg-white/5 rounded-lg p-3 border-l-4 ${trigger.type === 'upper' ? 'border-green-400' : 'border-red-400'}">
                        <div class="flex justify-between items-center">
                            <div>
                                <span class="font-bold">${symbol}</span>
                                <span class="text-gray-300">cruz√≥ ${trigger.type === 'upper' ? 'por arriba' : 'por abajo'} de $${trigger.threshold.toFixed(2)}</span>
                                <span class="text-purple-400">a $${trigger.price.toFixed(2)}</span>
                                ${trigger.emailSent ? '<span class="text-green-400">üìß‚úì</span>' : '<span class="text-red-400">üìß‚úó</span>'}
                            </div>
                            <span class="text-sm text-gray-400">${date.toLocaleString('es')}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Fetch current prices
        async function fetchPrices() {
            const symbols = [...new Set(alerts.map(a => a.symbol))];
            
            if (symbols.length === 0) return;

            try {
                const response = await fetch(`https://api.binance.com/api/v3/ticker/price`);
                const data = await response.json();
                
                symbols.forEach(symbol => {
                    const ticker = data.find(t => t.symbol === symbol);
                    if (ticker) {
                        prices[symbol] = parseFloat(ticker.price);
                    }
                });

                checkAlerts();
                renderAlerts();
            } catch (error) {
                console.error('Error fetching prices:', error);
            }
        }

        // Check if any alerts should trigger
        function checkAlerts() {
            alerts.forEach(alert => {
                if (!alert.active) return;

                const currentPrice = prices[alert.symbol];
                if (!currentPrice) return;

                // Check lower threshold
                if (alert.lowerThreshold !== null && currentPrice <= alert.lowerThreshold) {
                    triggerAlert(alert, currentPrice, 'lower');
                }

                // Check upper threshold
                if (alert.upperThreshold !== null && currentPrice >= alert.upperThreshold) {
                    triggerAlert(alert, currentPrice, 'upper');
                }
            });
        }

        // Trigger alert
        async function triggerAlert(alert, currentPrice, type) {
            const trigger = {
                symbol: alert.symbol,
                price: currentPrice,
                threshold: type === 'lower' ? alert.lowerThreshold : alert.upperThreshold,
                type,
                timestamp: new Date().toISOString(),
                emailSent: false
            };

            // Check if this exact alert was already triggered recently (within 5 minutes)
            const recentTrigger = triggeredAlerts.find(t => 
                t.symbol === trigger.symbol && 
                t.type === trigger.type &&
                (Date.now() - new Date(t.timestamp).getTime()) < 5 * 60 * 1000
            );

            if (recentTrigger) return;

            // Send email notification
            const emailSent = await sendEmailNotification(trigger);
            trigger.emailSent = emailSent;

            triggeredAlerts.push(trigger);
            localStorage.setItem('triggeredAlerts', JSON.stringify(triggeredAlerts));
            renderHistory();

            // Show browser notification
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('üö® Alerta de Precio', {
                    body: `${alert.symbol.replace('USDT', '')} ${type === 'upper' ? 'subi√≥ a' : 'baj√≥ a'} $${currentPrice.toFixed(2)}`,
                    icon: 'üö®'
                });
            }
        }

        // Send email notification via backend
        async function sendEmailNotification(trigger) {
            if (!userEmail) {
                console.log('No email configured');
                return false;
            }

            if (!serverConnected) {
                console.log('Server not connected');
                return false;
            }

            try {
                const symbol = trigger.symbol.replace('USDT', '');
                const direction = trigger.type === 'upper' ? 'SUBI√ì POR ARRIBA' : 'BAJ√ì POR DEBAJO';
                const emoji = trigger.type === 'upper' ? 'üìà' : 'üìâ';
                
                const subject = `üö® ALERTA: ${symbol} ${direction} de $${trigger.threshold.toFixed(2)}`;
                
                const html = `
                    <div style="font-family: Arial, sans-serif; padding: 20px; background-color: #1e293b;">
                        <div style="max-width: 600px; margin: 0 auto; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 15px;">
                            <h1 style="color: white; text-align: center; font-size: 32px; margin-bottom: 20px;">
                                ${emoji} Alerta de Precio
                            </h1>
                            
                            <div style="background-color: rgba(255, 255, 255, 0.1); padding: 25px; border-radius: 10px; margin-bottom: 20px;">
                                <h2 style="color: white; margin-top: 0;">${symbol}</h2>
                                <p style="color: white; font-size: 18px; margin: 10px 0;">
                                    Ha cruzado el umbral <strong>${trigger.type === 'upper' ? 'superior' : 'inferior'}</strong>
                                </p>
                                <div style="background-color: rgba(255, 255, 255, 0.2); padding: 15px; border-radius: 8px; margin: 15px 0;">
                                    <p style="color: white; font-size: 16px; margin: 5px 0;">
                                        üí∞ Precio actual: <strong style="font-size: 24px;">$${trigger.price.toFixed(2)}</strong>
                                    </p>
                                    <p style="color: white; font-size: 16px; margin: 5px 0;">
                                        üéØ Umbral configurado: <strong>$${trigger.threshold.toFixed(2)}</strong>
                                    </p>
                                    <p style="color: white; font-size: 14px; margin: 5px 0;">
                                        üìÖ Fecha: ${new Date(trigger.timestamp).toLocaleString('es')}
                                    </p>
                                </div>
                            </div>
                            
                            <p style="color: rgba(255, 255, 255, 0.8); text-align: center; font-size: 14px;">
                                Sistema de Alertas de Criptomonedas
                            </p>
                        </div>
                    </div>
                `;

                const text = `
                    ALERTA DE PRECIO: ${symbol}
                    
                    ${symbol} ha cruzado el umbral ${trigger.type === 'upper' ? 'superior' : 'inferior'}.
                    
                    Precio actual: $${trigger.price.toFixed(2)}
                    Umbral configurado: $${trigger.threshold.toFixed(2)}
                    Fecha: ${new Date(trigger.timestamp).toLocaleString('es')}
                `;

                const response = await fetch(`${serverUrl}/api/send-alert`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        to: userEmail,
                        subject,
                        text,
                        html
                    })
                });

                const data = await response.json();

                if (data.success) {
                    console.log('‚úÖ Email enviado exitosamente');
                    return true;
                } else {
                    console.error('‚ùå Error al enviar email:', data.error);
                    return false;
                }
            } catch (error) {
                console.error('Error sending email:', error);
                return false;
            }
        }

        // Request notification permission
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        // Initialize
        loadData();
        renderAlerts();
        requestNotificationPermission();
        testServer(); // Auto-test server connection

        // Start monitoring
        monitoringInterval = setInterval(fetchPrices, 10000); // Check every 10 seconds
        fetchPrices(); // Initial fetch
    </script>
</body>
</html>
